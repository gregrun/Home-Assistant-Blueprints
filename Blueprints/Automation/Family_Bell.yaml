blueprint:
  name: Family Bell (Simple TTS)
  description: >
    A lightweight replacement for Google Home's Family Bell.
    Schedule a spoken message to one or more speakers on selected weekdays,
    with optional chime and temporary volume. Create one automation per bell.
  domain: automation
  input:
    bell_name:
      name: Bell name (for your reference)
      selector:
        text: {}
    media_players:
      name: Speakers
      description: One or more media_player entities (Google/Nest, Sonos, etc.)
      selector:
        target:
          entity:
            domain: media_player
    bell_time:
      name: Time
      selector:
        time: {}
    weekdays:
      name: Days of week
      selector:
        select:
          mode: list
          multiple: true
          options: [Mon, Tue, Wed, Thu, Fri, Sat, Sun]
      default: [Mon, Tue, Wed, Thu, Fri]
    tts_service:
      name: TTS service
      description: Choose a TTS service you have enabled.
      selector:
        select:
          options:
            - tts.google_translate_say
            - tts.cloud_say
      default: tts.google_translate_say
    language:
      name: Language (optional; used by google_translate)
      default: en
      selector:
        text: {}
    volume:
      name: Temporary volume (optional)
      description: 0.0â€“1.0; leave blank to keep current volume
      default:
      selector:
        number:
          min: 0
          max: 1
          step: 0.05
          mode: slider
    pre_chime_url:
      name: Chime URL (optional)
      description: Public or internal URL to a short MP3/WAV to play before TTS
      default:
      selector:
        text: {}
    message:
      name: Message to speak
      selector:
        text:
          multiline: true

mode: queued
max: 50

trigger:
  - platform: time
    at: !input bell_time

variables:
  weekdays: !input weekdays
  message: !input message
  tts_service: !input tts_service
  lang: !input language
  tmp_volume: !input volume
  chime: !input pre_chime_url

condition:
  - condition: template
    value_template: >
      {% set today = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'][now().weekday()] %}
      {{ today in weekdays }}

action:
  # Optional temporary volume (applies to all selected speakers)
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ tmp_volume is not none and (tmp_volume | string) != '' }}"
        sequence:
          - service: media_player.volume_set
            target: !input media_players
            data:
              volume_level: "{{ tmp_volume | float(0) }}"
    default: []

  # Optional chime (short delay to let it start)
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ (chime | default('')) | length > 0 }}"
        sequence:
          - service: media_player.play_media
            target: !input media_players
            data:
              media_content_id: "{{ chime }}"
              media_content_type: music
          - delay: "00:00:02"
    default: []

  # Speak the message (branch per service; plain YAML data)
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ tts_service == 'tts.google_translate_say' }}"
        sequence:
          - service: tts.google_translate_say
            target: !input media_players
            data:
              message: "{{ message }}"
              language: "{{ lang }}"
      - conditions:
          - condition: template
            value_template: "{{ tts_service == 'tts.cloud_say' }}"
        sequence:
          - service: tts.cloud_say
            target: !input media_players
            data:
              message: "{{ message }}"
    default:
      - service: "{{ tts_service }}"
        target: !input media_players
        data:
          message: "{{ message }}"