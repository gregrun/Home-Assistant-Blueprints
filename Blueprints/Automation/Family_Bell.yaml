blueprint:
  name: Family Bell (TTS entity + chime + school days)
  domain: automation
  description: >
    Speak a message on selected weekdays at a set time using a TTS entity
    (e.g., tts.google_en_com). Optional pre-chime and temporary volume boost.
    Loops each selected media_player. If "School days only" is enabled, runs
    Mon–Fri and skips when the selected calendar has a current event whose title
    contains "no school" (case-insensitive). Leaves speaker volume unchanged
    after announcement.

  input:
    tts_entity:
      name: TTS voice/entity
      selector:
        entity:
          domain: tts

    media_players:
      name: Speakers (pick one or more)
      selector:
        entity:
          domain: media_player
          multiple: true

    bell_time:
      name: Time
      selector:
        time: {}

    weekdays:
      name: Days of week
      selector:
        select:
          mode: list
          multiple: true
          options: [mon, tue, wed, thu, fri, sat, sun]
      default: [mon, tue, wed, thu, fri]

    message:
      name: Message to speak
      selector:
        text:
          multiline: true

    volume:
      name: Temporary volume (optional)
      description: "0.0–1.0; leave blank to keep current volume"
      default:
      selector:
        number:
          min: 0
          max: 1
          step: 0.05
          mode: slider

    chime_url:
      name: Pre-chime URL (optional)
      description: "Short MP3/WAV reachable by HA (e.g., /media/chimes/bell.mp3 or http(s) URL)"
      default:
      selector:
        text: {}

    chime_delay:
      name: Delay after chime (seconds)
      default: 2
      selector:
        number:
          min: 0
          max: 10
          step: 1
          mode: slider

    school_days_only:
      name: School days only
      description: "Run only Mon–Fri and skip if calendar has a current 'No School' event"
      default: false
      selector:
        boolean: {}

    school_calendar:
      name: School calendar
      description: "Calendar entity to check for 'No School' (e.g., calendar.family)"
      default: calendar.family
      selector:
        entity:
          domain: calendar

mode: single

trigger:
  - platform: time
    at: !input bell_time

variables:
  tmp_volume: !input volume
  chime: !input chime_url
  chime_wait: !input chime_delay
  say_text: !input message
  cal_entity: !input school_calendar
  school_only: !input school_days_only

condition:
  - condition: time
    weekday: !input weekdays

  - condition: template
    value_template: >
      {%- if not school_only -%}
        true
      {%- else -%}
        {# Mon–Fri check #}
        {%- set weekday_ok = now().weekday() in [0,1,2,3,4] -%}
        {%- set msg = (state_attr(cal_entity, 'message') or '') | lower -%}
        {%- set no_school = 'no school' in msg -%}
        {{ weekday_ok and (not no_school) }}
      {%- endif -%}

action:
  - repeat:
      for_each: !input media_players
      sequence:
        - variables:
            speaker: "{{ repeat.item }}"

        # Optional temporary volume boost
        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ tmp_volume is not none and (tmp_volume | string) != '' }}"
              sequence:
                - service: media_player.volume_set
                  data:
                    entity_id: "{{ speaker }}"
                    volume_level: "{{ tmp_volume | float(0) }}"
          default: []

        # Optional chime before speaking
        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ (chime | default('')) | length > 0 }}"
              sequence:
                - service: media_player.play_media
                  data:
                    entity_id: "{{ speaker }}"
                    media_content_id: "{{ chime }}"
                    media_content_type: music
                - delay:
                    seconds: "{{ chime_wait | int(0) }}"
          default: []

        # Speak the message
        - service: tts.speak
          target:
            entity_id: !input tts_entity
          data:
            media_player_entity_id: "{{ speaker }}"
            message: "{{ say_text }}"